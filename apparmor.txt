#include <tunables/global>

profile local_snips-base flags=(attach_disconnected,mediate_deleted) {
	#include <abstractions/base>
	#include <abstractions/bash>
	#include <abstractions/nameservice>
	#include <abstractions/openssl>
	#include <abstractions/ssl_certs>

# These are from <abstractions/python, but we must ensure python 3.6 & 3.7 are supported, as some systems only support up to python 3.5. Note the file this comes from is under GPL v2!
	/usr/lib{,32,64}/python{2.[4-7],3.[0-7]}/**.{pyc,so}           mr,
	/usr/lib{,32,64}/python{2.[4-7],3.[0-7]}/**.{egg,py,pth}       r,
	/usr/lib{,32,64}/python{2.[4-7],3.[0-7]}/{site,dist}-packages/ r,
	/usr/lib{,32,64}/python3.[0-7]/lib-dynload/*.so            mr,

	/usr/local/lib{,32,64}/python{2.[4-7],3.[0-7]}/**.{pyc,so}           mr,
	/usr/local/lib{,32,64}/python{2.[4-7],3.[0-7]}/**.{egg,py,pth}       r,
	/usr/local/lib{,32,64}/python{2.[4-7],3.[0-7]}/{site,dist}-packages/ r,
	/usr/local/lib{,32,64}/python3.[0-7]/lib-dynload/*.so            mr,

	# Site-wide configuration
	/etc/python{2.[4-7],3.[0-7]}/** r,

	# shared python paths
	/usr/share/{pyshared,pycentral,python-support}/**      r,
	/{var,usr}/lib/{pyshared,pycentral,python-support}/**  r,
	/usr/lib/{pyshared,pycentral,python-support}/**.so     mr,
	/var/lib/{pyshared,pycentral,python-support}/**.pyc    mr,
	/usr/lib/python3/dist-packages/**.so                   mr,

	# wx paths
	/usr/lib/wx/python/*.pth r,
	# python build configuration and headers
	/usr/include/python{2.[4-7],3.[0-7]}*/pyconfig.h r,
# End of python
	/usr/share/python-wheels/ r,
	/usr/share/python-wheels/** r,
	/usr/local/lib/python{2.[4-7],3.[0-7]}/{dist,site}-packages/** mrw,

	capability net_bind_service,
	capability setgid,
	capability setuid,
	capability dac_override,

	/config/** rw,
	# Uncomment the following when ready to not grant full perms to
	# /config/**
	#/config/python_scripts/ rw,
	#/config/python_scripts/** rw,
	/data/** r,
	/etc/ r,
	/etc/** r,
	/proc/** r,
	/share/** r,
	/ssl/** r,
	/usr/local/share/mimic/voices/** r,

	/usr/lib/locale/*/LC_MESSAGES** mr,
	/dev/tty rw,

	/etc/snips.toml rw,
	/etc/mosquitto/mosquitto.conf rw,
	/etc/supervisor/** mklrw,
	/supervisord.pid rw,

	/tmp/** mlkrw,
	/tmp/ mr,
	/usr/include/** mr,
	/usr/share/pkgconfig/ mr,
	/usr/share/pkgconfig/** mr,
	/usr/local/lib/pkgconfig/ mr,
	/usr/local/lib/pkgconfig/** mr,
	/usr/share/git-core/** mlkr,
	/usr/share/snips/** mlkrw,
	/var/lib/docker/overlay2/** mlkrwix,
	/var/lib/snips/** mlkrw,
	/run/ mr,
	/run/supervisor.sock* mlkrw,
	/var/run/ mr,
	/var/run/supervisor.sock* mlkrw,
	/share/snips/** lkrw,
	/funcs.sh r,

	/root/ mkr,
	/root/.cache/ mlkrw,
	/root/.cache/** mlkrw,

	/sbin/ldconfig rix,
	/sbin/ldconfig.real rix,
	/usr/lib/gcc/x86_64-linux-gnu/*/* rix,
	/ingress/ r,
	/ingress/control.py mr,
	/ingress/templates/ r,
	/ingress/templates/index.html mr,
	/run.sh rix,
	/start_service.sh rix,
	/extract_assistant.sh rix,
	/wait-for-it.sh rix,
	/bin/* rcix,
	/usr/bin/ r,
	/usr/bin/* rix,
	/usr/local/bin/* rix,
	/usr/lib/bashio/* rix,
	/usr/lib/git-core/* rix,
	/usr/sbin/mosquitto mrcx,
	/var/lib/snips/skills/**/*.py mlkrwix,
	/var/lib/snips/skills/*/{venv,virtualenv}/bin/** mlkrwix,

	profile /usr/sbin/mosquitto flags=(attach_disconnected,mediate_deleted) {
		#include <abstractions/base>
		#include <abstractions/nameservice>
		#include <abstractions/openssl>
		#include <abstractions/ssl_certs>

		/data/mosquitto.db mlkrw,
		/data/mosquitto.db.new mlkrw,
		/etc/mosquitto/mosquitto.conf r,
		/etc/mosquitto/conf.d/ r,
		/etc/mosquitto/conf.d/* r,
		/var/lib/docker/overlay2/**/etc/mosquitto/conf.d/ r,
		/var/lib/docker/overlay2/**/etc/mosquitto/conf.d/* r,
		/share/** r,
		/var/lib/mosquitto/ r,
		/var/lib/mosquitto/mosquitto.db rwk,
		/var/run/mosquitto.pid rw,
		/usr/sbin/mosquitto mr,

		network inet stream,
		network inet6 stream,
		network inet dgram,
		network inet6 dgram,

		capability net_bind_service,
		capability setgid,
		capability setuid,

		/lib{,32,64}/libwrap.so* mr,
		/etc/hosts.allow r,
		/etc/hosts.deny r,
	}
}

<!doctype html>
<html>
    <head>
        <title>Snips Base Web UI</title>
        <style>
            .button {
                background-color: #03a9f4;
                border: none;
                cursor: pointer;
                color: white;
                float: left;
                outline: none;
                padding: 14px 16px;
                font-size: 16px;
                font-weight: normal;
            }
            .buttonActive {
                background-color: white;
                color: #03a9f4;
                font-weight: bold;
                outline: 3px solid #03a9f4;
                outline-offset: -3px;
            }
            .buttonContainer {
                background-color: #03a9f4;
                border: none;
                cursor: pointer;
                color: white;
                float: left;
                font-size: 16px;
                margin: 0;
                outline: none;
                width: 100%;
            }
            .tab {
                background-color: white;
                border: 10px solid white;
                color: black;
                height: 100%;
                padding: 0;
                overflow-x: auto;
            }
            .tabBox {
                background-color: white;
                color: black;
                padding: 0;
                width: 100%;
                box-shadow: 1px 1px 1px 1px black;
            }
            .tabContainer {
                background-color: white;
                color: black;
                padding: 0;
                width: 100%;
            }
            .tabContent: {
                background-color: white;
                color: black;
                font-family: monospace;
                height: 100%;
                padding: 0;
            }
            #updateInterval {
                width: 40px;
            }
            h2 {
                color: #03a9f4;
                padding: 0px 0px 0px 10px;
            }
        </style>
        <script type="text/javascript" src="{{ root }}/ansi_up.js"></script>
        <script type="text/javascript">
            var intervalID = null;
            var updateInterval = 5000;
            var ansi_up = new AnsiUp;
            function setUpdateInterval() {
                var updateElement = document.getElementById("updateInterval");
                if (updateElement.value < 0.1)
                    updateElement.value = 0.1;

                window.updateInterval = updateElement.value * 1000;
                console.log('new Update Interval: ' + window.updateInterval);
                if (intervalID != null)
                {
                    clearInterval(window.intervalID);
                    intervalID = setInterval(updateCurrentLog, window.updateInterval);
                }
            }
            function showLog(fileName) {
                var buttons = document.getElementsByClassName('buttonActive');
                while (buttons[0])
                {
                    buttons[0].classList.remove('buttonActive');
                }
                var tabs = document.getElementsByClassName('tab');
                for (var idx = 0; idx < tabs.length; idx++)
                {
                    tabs[idx].style.display = 'none';
                }
                updateLog(fileName);
                var button = document.getElementById("button_" + fileName);
                button.classList.add('buttonActive');
                var tab = document.getElementById("tab_" + fileName);
                tab.style.display = 'block';
            }
            function updateCurrentLog() {
                var button = document.getElementsByClassName('buttonActive')[0];
                if (button)
                {
                    var fileName = button.id.split("_")[1];
                    updateLog(fileName);
                }
            }
            function updateAssistant() {
                var updateButton = document.getElementById('updateAssistantButton');
                updateButton.diabled = true;
                updateButton.setAttribute('disabled', 'disabled');
                var xhr = new XMLHttpRequest();
                xhr.open('GET', '{{ root }}/update-assistant', true);
                xhr.responseType = 'text';
                xhr.onload = function() {
                    if (xhr.readyState === xhr.DONE) {
                        var updateButton = document.getElementById('updateAssistantButton');
                        if (xhr.status == 200) {
                            alert("Finished updating the assistant!")
                        }
                        else {
                            alert("Failed to update the assistant!")
                        }
                        updateButton.diabled = false;
                        updateButton.removeAttribute('disabled');
                    }
                }
                xhr.send();
            }
            function updateLog(fileName) {
                var output = document.getElementById(fileName);
                var xhr = new XMLHttpRequest();
                xhr.open('GET', '{{ root }}/stream?log=' + fileName, true);
                xhr.responseType = 'text';
                xhr.onload = function() {
                    if (xhr.readyState === xhr.DONE) {
                        if (xhr.status == 200) {
                            output.innerHTML = ansi_up.ansi_to_html(xhr.responseText).replace(/(?:\r\n|\r|\n)/g, '<br />');
                        }
                    }
                }
                xhr.send();
            }
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(function() {
                    var button = document.getElementsByClassName('buttonActive')[0];
                    if (button)
                    {
                        var fileName = button.id.split("_")[1];
                        showLog(fileName);
                    }
                    window.intervalID = setInterval(updateCurrentLog, window.updateInterval);
                }, 100);
            });
        </script>
    </head>
    <body>
        <h2>Assistant Re-install and Update</h2>
        If you have replaced your assistant ZIP file, click the Update Assistant button. Please note this could take a few minutes.<br clear="all" />
        <input id="updateAssistantButton" value="Update Assistant" type="button" onclick="updateAssistant()" />
        <h2>Logs</h2>
        Update Interval: <input id="updateInterval" type="number" value="5.0" min="0.1" step="0.1" />&nbsp;<input value="Set" type="button" onclick="setUpdateInterval()" />
        <hr />
        <div class="tabBox">
        <div class="buttonContainer">
            {% for fileName in fileNames %}
            <button class="button buttonActive" id="button_{{ fileName }}" onclick="showLog('{{ fileName }}')">{{ fileName }}</button>
            {% endfor %}
        </div>
        <br clear="all" />
        <div class="tabContainer">
            {% for fileName in fileNames %}
                <div class="tab" id="tab_{{ fileName }}">
                    <div class="tabContent" id="{{ fileName }}">Loading data, please wait...</div>
                </div>
            {% endfor %}
        </div>
        </div>
    </body>
</html>

<!doctype html>
<html>
    <head>
        <title>Snips Base Web UI</title>
        <link rel="stylesheet" type="text/css" href="{{ root }}/static/index.css" />
        <script type="text/javascript" src="{{ root }}/static/ansi_up.js"></script>
        <script type="text/javascript" src="{{ root }}/static/ace.js"></script>
        <script type="text/javascript" src="{{ root }}/static/keybinding-emacs.js"></script>
        <script type="text/javascript" src="{{ root }}/static/keybinding-sublime.js"></script>
        <script type="text/javascript" src="{{ root }}/static/keybinding-vim.js"></script>
        <script type="text/javascript" src="{{ root }}/static/mode-ini.js"></script>
        <script type="text/javascript" src="{{ root }}/static/theme-textmate.js"></script>
        <script type="text/javascript">
            var intervalID = null;
            var updateInterval = 5000;
            var ansi_up = new AnsiUp;

            function enableSnipsWatchButtons()
            {
                var startButton = document.getElementById('button_start_snips_watch');
                var stopButton = document.getElementById('button_stop_snips_watch');

                var snipsWatchTab = document.getElementById('tab_snips-watch.log');
                if (snipsWatchTab)
                {
                    startButton.diabled = true;
                    startButton.setAttribute('disabled', 'disabled');
                    stopButton.diabled = false;
                    stopButton.removeAttribute('disabled');
                }
                else
                {
                    startButton.diabled = false;
                    startButton.removeAttribute('disabled');
                    stopButton.diabled = true;
                    stopButton.setAttribute('disabled', 'disabled');
                }
            }

            function setUpdateInterval() {
                var updateElement = document.getElementById("updateInterval");
                if (updateElement.value < 0.1)
                    updateElement.value = 0.1;

                window.updateInterval = updateElement.value * 1000;
                console.log('new Update Interval: ' + window.updateInterval);
                if (intervalID != null)
                {
                    clearInterval(window.intervalID);
                    intervalID = setInterval(updateCurrentLog, window.updateInterval);
                }
            }

            function showLog(fileName) {
                var buttons = document.getElementsByClassName('buttonActive');
                while (buttons[0])
                {
                    buttons[0].classList.remove('buttonActive');
                }
                var tabs = document.getElementsByClassName('tab');
                for (var idx = 0; idx < tabs.length; idx++)
                {
                    tabs[idx].style.display = 'none';
                }
                updateLog(fileName);
                var button = document.getElementById("button_" + fileName);
                button.classList.add('buttonActive');
                var tab = document.getElementById("tab_" + fileName);
                tab.style.display = 'block';
            }

            function startSnipsWatch() {
                var startButton = document.getElementById('button_start_snips_watch');
                startButton.diabled = true;
                startButton.setAttribute('disabled', 'disabled');
                var xhr = new XMLHttpRequest();
                xhr.open('GET', '{{ root }}/start_snips_watch');
                xhr.responseType = 'text';
                xhr.onload = function() {
                    if (xhr.readyState == xhr.DONE) {
                        window.location = window.location;
                    }
                }
                xhr.send();
            }

            function stopSnipsWatch() {
                var stopButton = document.getElementById('button_stop_snips_watch');
                stopButton.diabled = true;
                stopButton.setAttribute('disabled', 'disabled');
                var xhr = new XMLHttpRequest();
                xhr.open('GET', '{{ root }}/stop_snips_watch');
                xhr.responseType = 'text';
                xhr.onload = function() {
                    if (xhr.readyState == xhr.DONE) {
                        window.location = window.location;
                    }
                }
                xhr.send();
            }

            function updateCurrentLog() {
                var button = document.getElementsByClassName('buttonActive')[0];
                if (button)
                {
                    var fileName = button.id.split("_")[1];
                    updateLog(fileName);
                }
            }

            function updateAssistant() {
                var updateButton = document.getElementById('updateAssistantButton');
                updateButton.diabled = true;
                updateButton.setAttribute('disabled', 'disabled');
                var xhr = new XMLHttpRequest();
                xhr.open('GET', '{{ root }}/update-assistant', true);
                xhr.responseType = 'text';
                xhr.onload = function() {
                    if (xhr.readyState === xhr.DONE) {
                        var updateButton = document.getElementById('updateAssistantButton');
                        if (xhr.status == 200) {
                            alert("Finished updating the assistant!")
                        }
                        else {
                            alert("Failed to update the assistant!")
                        }
                        updateButton.diabled = false;
                        updateButton.removeAttribute('disabled');
                    }
                }
                xhr.send();
            }

            function updateLog(fileName) {
                var output = document.getElementById(fileName);
                var xhr = new XMLHttpRequest();
                xhr.open('GET', '{{ root }}/stream?log=' + fileName, true);
                xhr.responseType = 'text';
                xhr.onload = function() {
                    if (xhr.readyState === xhr.DONE) {
                        if (xhr.status == 200) {
                            output.innerHTML = ansi_up.ansi_to_html(xhr.responseText).replace(/(?:\r\n|\r|\n)/g, '<br />');
                        }
                    }
                }
                xhr.send();
            }

            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(function() {
                    enableSnipsWatchButtons();
                    var button = document.getElementsByClassName('buttonActive')[0];
                    if (button)
                    {
                        var fileName = button.id.split("_")[1];
                        showLog(fileName);
                    }
                    window.intervalID = setInterval(updateCurrentLog, window.updateInterval);
                }, 100);
            });
        </script>
    </head>
    <body>
        <h2>Assistant Re-install and Update</h2>
        <p>If you have replaced your assistant ZIP file, click the Update
        Assistant button. Please note this could take a few minutes.</p>
        <input id="updateAssistantButton" value="Update Assistant" type="button" onclick="updateAssistant()" />
        <h2>Snips-watch</h2>
        <p>You can start and stop snips-watch, even if you didn't configure it
        to be started.  Note that starting it here will not change the
        configuration.  If it is disabled in the configuration, the next time
        you restart this addon, snips-watch will not be running.</p>
        <p>The snips-watch log is always the first log file, when it is running.</p>
        <button id="button_start_snips_watch" onclick="startSnipsWatch()">Start snips-watch</button>
        <button id="button_stop_snips_watch" onclick="stopSnipsWatch()">Stop snips-watch</button>
        <h2>Logs</h2>
        Update Interval: <input id="updateInterval" type="number" value="5.0" min="0.1" step="0.1" />&nbsp;<input value="Set" type="button" onclick="setUpdateInterval()" />
        <hr />
        <div class="tabBox">
            <div class="buttonContainer">
                {% for fileName in fileNames %}
                <button class="button buttonActive" id="button_{{ fileName }}" onclick="showLog('{{ fileName }}')">{{ fileName }}</button>
                {% endfor %}
            </div>
            <br clear="all" />
            <div class="tabContainer">
                {% for fileName in fileNames %}
                <div class="tab" id="tab_{{ fileName }}">
                    <div class="tabContent" id="{{ fileName }}">Loading data, please wait...</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </body>
</html>
